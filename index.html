<html>
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <style> circle {fill: grey; stroke: black;} </style>
    <body onload='init()'>
        <label for="cylinders">Select number of cylinders: </label>
        <select id="cylinders" onchange="update()">
          <option value="all">All</option>
          <option value="4">4</option>
          <option value="6">6</option>
          <option value="8">8</option>
        </select>
        <svg width=600 height=600>
        </svg>
        <script>
            let data;

            async function init() {
                data = await d3.csv("https://flunky.github.io/cars2017.csv");
                update();
            }

            function update() {
                const selectedCylinders = document.getElementById("cylinders").value;

                // Set up the SVG dimensions and margins
                const margin = 50;
                const width = 600 - 2*margin;
                const height = 600 - 2*margin;

                d3.select("svg").selectAll("*").remove();

                // Create SVG element
                const svg = d3.select("svg")
                    .attr("width", width + 2*margin)
                    .attr("height", height + 2*margin)
                    .append("g")
                    .attr("transform", `translate(${margin},${margin})`);

                // Define scales and axes
                const xScale = d3.scaleLinear()
                    .domain([5, 50])
                    .range([0, width]);

                const yScale = d3.scaleLinear()
                    .domain([5, 50])
                    .range([height, 0]);

                const xAxis = d3.axisBottom(xScale)
                    .tickValues([10, 20, 30, 40, 50])
                    .tickFormat(d3.format("~s"));

                const yAxis = d3.axisLeft(yScale)
                    .tickValues([10, 20, 30, 40, 50])
                    .tickFormat(d3.format("~s"));

                // Filter data based on selected cylinders and fuel type
                    const filteredData = data.filter(d => {
                        const fuel = d['Fuel'];
                        return (fuel !== 'Electricity');
                    }).sort((a, b) => {
                        if (selectedCylinders === 'all') return 0;
                        if (a['EngineCylinders'] == selectedCylinders && b['EngineCylinders'] != selectedCylinders) return 1;
                        if (a['EngineCylinders'] != selectedCylinders && b['EngineCylinders'] == selectedCylinders) return -1;
                        return 0;
                    });

                svg.selectAll("circle")
                    .data(filteredData)
                    .enter().append("circle")
                    .attr("cx", d => xScale(parseFloat(d['AverageCityMPG'])))
                    .attr("cy", d => yScale(parseFloat(d['AverageHighwayMPG'])))
                    .attr("r", d => {
                        if (d['EngineCylinders'] == selectedCylinders || selectedCylinders === 'all') return 5;
                        else return 3;
                    })
                    .style("fill", d => {
                        if (d['EngineCylinders'] == selectedCylinders || selectedCylinders === 'all') { 
                            if (d['Fuel'] === 'Gasoline') return 'red';
                            else return 'green';
                        } else {
                            return 'grey';
                        }
                    })

                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", `translate(0, ${height})`)
                    .call(xAxis);

                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);
                
                //X-Axis label
                svg.append("text")
                    .attr("class", "x label")
                    .attr("text-anchor", "end")
                    .attr("x", width / 2 + 70)
                    .attr("y", height + margin - 10)
                    .text("Average City MPG");

                // Y Axis Label
                svg.append("text")
                    .attr("class", "y label")
                    .attr("text-anchor", "end")
                    .attr("y", -margin + 5)
                    .attr("x", -height / 2 + 70)
                    .attr("dy", ".75em")
                    .attr("transform", "rotate(-90)")
                    .text("Average Highway MPG");

                // Add Title
                svg.append("text")
                    .attr("class", "title")
                    .attr("text-anchor", "middle")
                    .attr("x", width / 2)
                    .attr("y", -margin / 2)
                    .text("Average MPG for Cars with Various Engine Cylinders");
            }

        </script>
    </body>
</html>
        